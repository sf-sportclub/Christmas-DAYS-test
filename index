<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #000
        url('https://firebasestorage.googleapis.com/v0/b/pichayut-40dd2.firebasestorage.app/o/pexels-cottonbro-6072439.jpg?alt=media&token=7732ed40-e69f-477e-b342-571957c9c09a')
        no-repeat center center fixed;
      background-size: cover;
      color: #f9fafb;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 1.4rem;
      color: #fefce8;
      text-shadow: 0 2px 4px rgba(0,0,0,0.6);
    }
    .card {
      max-width: 540px;
      margin: 0 auto;
      background: rgba(15,23,42,0.85);
      border-radius: 16px;
      padding: 16px 16px 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
      border: 1px solid rgba(248,250,252,0.15);
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #e5e7eb;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      font-size: 16px; /* ‡∏Å‡∏±‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ã‡∏π‡∏° */
      margin-bottom: 10px;
      background: rgba(15,23,42,0.9);
      color: #f9fafb;
    }
    input[type="text"]::placeholder {
      color: #9ca3af;
    }
    input[readonly] {
      background: rgba(15,23,42,0.8);
    }
    .row-2 {
      display: flex;
      gap: 8px;
    }
    .row-2 > div {
      flex: 1 1 0;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 8px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 16px; /* ‡∏Å‡∏±‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ã‡∏π‡∏° */
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.2s;
      white-space: nowrap;
    }
    button:active {
      transform: scale(0.97);
      box-shadow: 0 3px 8px rgba(0,0,0,0.4);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(135deg, #16a34a, #15803d, #b91c1c);
      color: #fefce8;
      box-shadow: 0 4px 12px rgba(22,163,74,0.6);
    }
    .btn-secondary {
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.7);
    }
    .btn-outline {
      background: transparent;
      border: 1px solid rgba(148,163,184,0.9);
      color: #e5e7eb;
    }
    .btn-full {
      width: 100%;
      margin-top: 6px;
    }
    .msg {
      font-size: 0.85rem;
      margin-top: 2px;
      margin-bottom: 6px;
    }
    .msg.info { color: #bfdbfe; }
    .msg.warn { color: #fbbf24; }
    .msg.error { color: #fecaca; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 0.7rem;
      border-radius: 999px;
      background: rgba(254,240,138,0.15);
      color: #facc15;
      margin-left: 4px;
      vertical-align: middle;
      border: 1px solid rgba(250,204,21,0.4);
    }

    .ticket-wrap {
      max-width: 540px;
      margin: 16px auto 0;
    }
    .ticket {
      position: relative;
      background: radial-gradient(circle at top left, #facc15, #b91c1c 40%, #14532d 100%);
      color: #fff;
      border-radius: 18px;
      padding: 16px 16px 18px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.55);
      overflow: hidden;
      border: 1px solid rgba(250,250,250,0.4);
    }
    .ticket:before,
    .ticket:after {
      content: "";
      position: absolute;
      top: 16px;
      bottom: 16px;
      width: 18px;
      background: #0f172a;
      border-radius: 999px;
    }
    .ticket:before { left: -9px; }
    .ticket:after { right: -9px; }
    .ticket-inner {
      position: relative;
      z-index: 1;
    }
    .ticket-title {
      font-weight: 700;
      font-size: 1.15rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ticket-title span.emoji {
      font-size: 1.2rem;
    }
    .ticket-sub {
      font-size: 0.85rem;
      opacity: 0.95;
      margin-bottom: 10px;
    }
    .ticket-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .ticket-label {
      opacity: 0.9;
    }
    .ticket-value {
      font-weight: 600;
    }
    .ticket-lucky {
      margin-top: 10px;
      text-align: center;
      padding: 10px;
      border-radius: 12px;
      background: rgba(15,23,42,0.35);
      border: 1px dashed rgba(255,255,255,0.85);
      font-size: 1.1rem;
      letter-spacing: 0.15em;
    }
    .ticket-hint {
      margin-top: 6px;
      font-size: 0.8rem;
      opacity: 0.95;
      text-align: center;
    }

    .ticket-tabs {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.8rem;
    }
    .ticket-tab {
      flex: 1 1 0;
      border-radius: 10px;
      padding: 6px 8px;
      background: rgba(15,23,42,0.35);
      border: 1px dashed rgba(248,250,252,0.5);
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
    }
    .ticket-tab.used {
      background: rgba(22,163,74,0.4);
      border-style: solid;
      border-color: rgba(22,163,74,0.9);
    }
    .ticket-tab-title {
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .ticket-tab-status {
      opacity: 0.95;
    }

    .ticket-qr {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .ticket-qr-label {
      font-size: 0.8rem;
      opacity: 0.95;
    }

    .ticket-print-btn {
      margin-top: 8px;
      display: flex;
      justify-content: center;
    }

    .hidden { display: none; }

    .footer-tip {
      max-width: 540px;
      margin: 10px auto 0;
      font-size: 0.8rem;
      color: #e5e7eb;
      text-align: center;
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    }

    .loading {
      font-size: 0.8rem;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 4px;
    }
    .loading-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #9ca3af;
      animation: blink 1s infinite ease-in-out;
    }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; }
      40% { opacity: 1; }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      .card {
        padding: 12px 12px 16px;
      }
      .row-2 {
        flex-direction: column;
      }
    }

    @media print {
      body {
        background: #fff;
        padding: 0;
      }
      .card, .footer-tip {
        display: none !important;
      }
      .ticket-wrap {
        margin-top: 0;
      }
      .ticket {
        box-shadow: none;
      }
      .ticket-print-btn {
        display: none !important;
      }
    }

    /* === Suggestion list ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÅ‡∏ó‡∏ô datalist) === */
    .empid-wrap {
      position: relative;
    }
    #empIdSuggestions {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 2px;
      background: rgba(15,23,42,0.98);
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.8);
      max-height: 220px;
      overflow-y: auto;
      z-index: 30;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
    }
    .suggest-list {
      padding: 4px 0;
    }
    .suggest-item {
      padding: 6px 10px;
      font-size: 0.9rem;
      cursor: pointer;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .suggest-item:hover {
      background: rgba(55,65,81,0.9);
    }
    .suggest-item strong {
      font-weight: 700;
      color: #facc15;
    }
    .suggest-empty {
      padding: 6px 10px;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    /* === Queue Status === */
    .queue-status {
      background: rgba(15,23,42,0.9);
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
      border: 1px solid rgba(148,163,184,0.3);
    }
    .queue-status-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: #facc15;
    }
    .queue-status-info {
      font-size: 0.9rem;
      margin-bottom: 5px;
    }
    .queue-progress {
      width: 100%;
      height: 8px;
      background: rgba(148,163,184,0.3);
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }
    .queue-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #16a34a, #facc15);
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <h1>üéÑ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚Äì Christmas Event üéÅ</h1>

  <div class="card">
    <div style="margin-bottom: 10px; font-size: 0.85rem; color:#e5e7eb;">
      ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô<br>
      - ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á<br>
      - ‡∏ñ‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á <strong>‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡∏ù‡πà‡∏≤‡∏¢, ‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°</strong> ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>
      - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>
      - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <strong>GAME / ICE CREAM</strong> ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å‡πÉ‡∏ô Excel (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F, G) ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
    </div>

    <label for="empId">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
    <div class="empid-wrap">
      <input type="text" id="empId" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1000000001 ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå 5 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢" autocomplete="off">
      <div id="empIdSuggestions" class="hidden"></div>
    </div>

    <div class="btn-row">
      <button type="button" class="btn-secondary" onclick="triggerEmpLookup()">
        üîç ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™
      </button>
      <span id="loadingEmpList" class="loading hidden">
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
      </span>
    </div>
    <div id="msgEmp" class="msg"></div>

    <div class="row-2">
      <div>
        <label for="firstName">‡∏ä‡∏∑‡πà‡∏≠</label>
        <input type="text" id="firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á">
      </div>
      <div>
        <label for="lastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="lastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
    </div>

    <label for="department">‡∏ù‡πà‡∏≤‡∏¢ / ‡πÅ‡∏ú‡∏ô‡∏Å</label>
    <input type="text" id="department" placeholder="‡πÄ‡∏ä‡πà‡∏ô Top Department">

    <label for="luckyNumber">
      ‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°
      <span class="badge">‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™ (0000‚Äì0399)</span>
    </label>
    <input type="text" id="luckyNumber" readonly placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° &quot;‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç&quot;">
    <div class="btn-row">
      <button type="button" class="btn-outline" id="luckyBtn" onclick="requestLucky()">
        üé≤ ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç / ‡∏î‡∏π‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏°
      </button>
      <span id="loadingLucky" class="loading hidden">
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
      </span>
    </div>
    <div id="msgLucky" class="msg"></div>

    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß -->
    <div id="queueStatus" class="queue-status hidden">
      <div class="queue-status-title">üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç</div>
      <div class="queue-status-info" id="queueInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</div>
      <div class="queue-progress">
        <div class="queue-progress-bar" id="queueProgressBar"></div>
      </div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="btn-row">
      <button type="button" class="btn-secondary btn-full" onclick="saveOnly()">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </div>
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô) -->
    <div class="btn-row">
      <button type="button" class="btn-primary btn-full" onclick="showTicket()">
        üéüÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      </button>
    </div>
    <div id="msgSave" class="msg"></div>
  </div>

  <div id="ticketSection" class="ticket-wrap hidden">
    <div class="ticket">
      <div class="ticket-inner">
        <div class="ticket-title">
          <span class="emoji">üéÑ</span>
          <span>Christmas Lucky Draw</span>
        </div>
        <div class="ticket-sub">Merry Christmas! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>

        <div class="ticket-row">
          <div class="ticket-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
          <div class="ticket-value" id="ticketName">-</div>
        </div>
        <div class="ticket-row">
          <div class="ticket-label">‡∏ù‡πà‡∏≤‡∏¢ / ‡πÅ‡∏ú‡∏ô‡∏Å</div>
          <div class="ticket-value" id="ticketDept">-</div>
        </div>
        <div class="ticket-row">
          <div class="ticket-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
          <div class="ticket-value" id="ticketEmpId">-</div>
        </div>

        <div class="ticket-lucky">
          ‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span id="ticketLucky">----</span>
        </div>

        <!-- ‡πÅ‡∏ó‡πá‡∏ö GAME / ICE CREAM ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Excel -->
        <div class="ticket-tabs">
          <div class="ticket-tab" id="ticketGameTab">
            <div class="ticket-tab-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
            <div class="ticket-tab-status" id="ticketGameStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
          </div>
          <div class="ticket-tab" id="ticketIceTab">
            <div class="ticket-tab-title">GAME</div>
            <div class="ticket-tab-status" id="ticketIceStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
          </div>
        </div>

        <!-- QR CODE ‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
        <div class="ticket-qr">
          <div id="ticketQr"></div>
          <div class="ticket-qr-label">‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
        </div>

        <div class="ticket-hint">
          * ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™
        </div>
      </div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡πÉ‡∏ä‡πâ window.print) -->
    <div class="ticket-print-btn">
      <button type="button" class="btn-outline" onclick="printTicket()">
        üñ®Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å / ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
      </button>
    </div>
  </div>

  <div class="footer-tip">
    ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å / ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üéÖ
  </div>

  <!-- QRCode library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // URL Web App ‡∏Ç‡∏≠‡∏á Apps Script (‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°)
    const API_URL = 'https://script.google.com/macros/s/AKfycbwUrfAn48S_DuVzpLSjstREwqafsV6Rxhi4ZTWq6LLhsgTnjylVllG7LZAP9_D39uuO9w/exec';

    var empMap = {};            // key = empId
    var empIndex = [];          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (debounce)
    var lastSavedRecord = null; // ‡πÄ‡∏Å‡πá‡∏ö record ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    var isLoading = false;      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏Ç‡∏ì‡∏∞‡πÇ‡∏´‡∏•‡∏î
    var pollInterval = null;    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö interval ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£ poll ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

    // debounce helper
    function debounce(fn, delay) {
      var t = null;
      return function() {
        var ctx = this, args = arguments;
        clearTimeout(t);
        t = setTimeout(function() {
          fn.apply(ctx, args);
        }, delay);
      };
    }

    // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô loading ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°
    function setLoading(isLoadingState, buttonsToDisable = []) {
      isLoading = isLoadingState;
      
      // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô loading indicators
      setLoading('loadingEmpList', isLoadingState && buttonsToDisable.includes('lookupBtn'));
      setLoading('loadingLucky', isLoadingState && buttonsToDisable.includes('luckyBtn'));
      
      // ‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°
      buttonsToDisable.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.disabled = isLoadingState;
        }
      });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô loading ‡∏ï‡∏≤‡∏° ID
    function setLoading(id, isLoadingState) {
      var el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle('hidden', !isLoadingState);
    }

    async function apiGetEmployees() {
      const res = await fetch(API_URL + '?action=getEmployees', { cache: 'no-store' });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'API error');
      return (json.result && json.result.employees) || [];
    }

    async function apiGetLucky(empId) {
      const url = API_URL + '?action=getLuckyNumber&empId=' + encodeURIComponent(empId);
      const res = await fetch(url, { cache: 'no-store' });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'API error');
      return json.result;
    }

    async function apiSaveEmployee(payload) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'saveEmployee', payload: payload || {} })
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'API error');
      return json.result;
    }

    async function apiAddToQueue(payload) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'addToQueue', payload: payload || {} })
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'API error');
      return json.result;
    }

    async function apiCheckMyStatus(payload) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'checkMyStatus', payload: payload || {} })
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'API error');
      return json.result;
    }

    function setMsg(id, text, type) {
      var el = document.getElementById(id);
      el.textContent = text || '';
      el.className = 'msg ' + (type || '');
    }

    function fillFormFromRecord(record) {
      if (!record) return;

      document.getElementById('empId').value      = record.empId || '';
      document.getElementById('firstName').value  = record.firstName || '';
      document.getElementById('lastName').value   = record.lastName || '';
      document.getElementById('department').value = record.department || '';
      document.getElementById('luckyNumber').value = record.luckyNumber || '';

      if (record.luckyNumber) {
        setMsg('msgLucky', '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'info');
      } else {
        setMsg('msgLucky', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç"', 'warn');
      }

      setMsg('msgEmp', '‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'info');
    }

    function clearFormForNew(empId) {
      document.getElementById('firstName').value  = '';
      document.getElementById('lastName').value   = '';
      document.getElementById('department').value = '';
      document.getElementById('luckyNumber').value = '';
      if (empId) {
        setMsg('msgEmp', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ', 'warn');
      } else {
        setMsg('msgEmp', '', '');
      }
      setMsg('msgLucky', '', '');
      lastSavedRecord = null;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ï‡πá‡∏° + ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ + 5 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢ + ‡∏ä‡∏∑‡πà‡∏≠
    function buildEmpIndex(list) {
      empIndex = [];
      (list || []).forEach(function(r) {
        if (!r.empId) return;
        var id = String(r.empId);
        var fullName = r.fullName || ((r.firstName || '') + ' ' + (r.lastName || '')).trim();
        var firstChar = id.charAt(0) || '';
        var last5 = id.slice(-5);
        var label = (id + ' ' + fullName).trim();
        var key = (id + ' ' + firstChar + ' ' + last5 + ' ' + fullName).toLowerCase();
        empIndex.push({
          empId: id,
          fullName: fullName,
          label: label,
          key: key
        });
      });
    }

    function renderEmpSuggestions(query) {
      var panel = document.getElementById('empIdSuggestions');
      panel.innerHTML = '';
      panel.classList.add('hidden');

      var q = (query || '').trim();
      if (!q) return;

      var lower = q.toLowerCase();
      var results = [];
      var MAX_RESULTS = 20;

      for (var i = 0; i < empIndex.length; i++) {
        var item = empIndex[i];
        if (item.key.indexOf(lower) !== -1) {
          results.push(item);
          if (results.length >= MAX_RESULTS) break;
        }
      }

      if (!results.length) {
        var empty = document.createElement('div');
        empty.className = 'suggest-empty';
        empty.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á';
        panel.appendChild(empty);
        panel.classList.remove('hidden');
        return;
      }

      var container = document.createElement('div');
      container.className = 'suggest-list';

      results.forEach(function(item) {
        var row = document.createElement('div');
        row.className = 'suggest-item';
        row.dataset.empId = item.empId;

        // ‡πÄ‡∏ô‡πâ‡∏ô‡∏£‡∏´‡∏±‡∏™
        var strong = document.createElement('strong');
        strong.textContent = item.empId;
        row.appendChild(strong);

        if (item.fullName) {
          var spanName = document.createElement('span');
          spanName.textContent = ' ‚Ä¢ ' + item.fullName;
          row.appendChild(spanName);
        }

        row.addEventListener('click', function() {
          selectEmpIdFromSuggestion(this.dataset.empId);
        });

        container.appendChild(row);
      });

      panel.appendChild(container);
      panel.classList.remove('hidden');
    }

    function hideEmpSuggestions() {
      var panel = document.getElementById('empIdSuggestions');
      panel.innerHTML = '';
      panel.classList.add('hidden');
    }

    function selectEmpIdFromSuggestion(empId) {
      var input = document.getElementById('empId');
      input.value = empId;
      hideEmpSuggestions();

      var rec = empMap[empId];
      if (rec) {
        fillFormFromRecord(rec);
        lastSavedRecord = rec;
      } else {
        clearFormForNew(empId);
      }
    }

    // ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° üîç ‡∏´‡∏£‡∏∑‡∏≠ Enter ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö exact match
    function lookupExactEmpId() {
      var v = document.getElementById('empId').value.trim();
      if (!v) {
        clearFormForNew('');
        hideEmpSuggestions();
        return;
      }
      var rec = empMap[v];
      if (rec) {
        fillFormFromRecord(rec);
        lastSavedRecord = rec;
        hideEmpSuggestions();
      } else {
        clearFormForNew(v);
      }
    }

    function triggerEmpLookup() {
      if (isLoading) return;
      lookupExactEmpId();
    }

    async function initEmpIds() {
      try {
        setLoading(true, ['lookupBtn']);
        setMsg('msgEmp', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...', 'info');
        const list = await apiGetEmployees();

        empMap = {};
        (list || []).forEach(function(r) {
          if (!r.empId) return;
          empMap[r.empId] = r;
        });

        buildEmpIndex(list);

        setMsg('msgEmp', '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏Ç‡πÄ‡∏ï‡πá‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ + 5 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', 'info');
      } catch (err) {
        console.error(err);
        setMsg('msgEmp', '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
      } finally {
        setLoading(false, ['lookupBtn']);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏¥‡∏ß)
    async function requestLucky() {
      if (isLoading) return;
      
      var empId = document.getElementById('empId').value.trim();
      if (!empId) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç');
        return;
      }
      setMsg('msgLucky', '', '');
      setMsg('msgSave', '', '');
      setLoading(true, ['luckyBtn']);

      try {
        // === ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß ===
        const res = await apiAddToQueue({ empId: empId });
        if (!res) {
          setMsg('msgLucky', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
          return;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß
        setMsg('msgLucky', res.message, 'info');
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß
        showQueueStatus(res.queueNumber);

        // === ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Polling) ===
        pollForResult(empId);

      } catch (err) {
        console.error(err);
        setMsg('msgLucky', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
      } finally {
        setLoading(false, ['luckyBtn']);
      }
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß
    function showQueueStatus(queueNumber) {
      const queueStatus = document.getElementById('queueStatus');
      const queueInfo = document.getElementById('queueInfo');
      const progressBar = document.getElementById('queueProgressBar');
      
      queueStatus.classList.remove('hidden');
      queueInfo.textContent = `‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${queueNumber} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...`;
      
      // ‡∏à‡∏≥‡∏•‡∏≠‡∏á progress bar
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90; // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏° 100% ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á
        progressBar.style.width = `${progress}%`;
      }, 1000);
      
      // ‡πÄ‡∏Å‡πá‡∏ö interval ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
      progressBar.dataset.interval = progressInterval;
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à
    function updateQueueStatusCompleted(luckyNumber) {
      const queueStatus = document.getElementById('queueStatus');
      const queueInfo = document.getElementById('queueInfo');
      const progressBar = document.getElementById('queueProgressBar');
      
      // ‡∏´‡∏¢‡∏∏‡∏î progress bar
      if (progressBar.dataset.interval) {
        clearInterval(progressBar.dataset.interval);
      }
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
      progressBar.style.width = '100%';
      queueInfo.textContent = `‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ ${luckyNumber}`;
      
      // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      setTimeout(() => {
        queueStatus.classList.add('hidden');
      }, 3000);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏∏‡∏Å‡πÜ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    function pollForResult(empId) {
      // ‡∏´‡∏¢‡∏∏‡∏î polling ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if (pollInterval) {
        clearInterval(pollInterval);
      }
      
      pollInterval = setInterval(async () => {
        try {
          const res = await apiCheckMyStatus({ empId: empId });
          if (!res) return;

          const status = res.status;
          const result = res.result;

          if (status === 'Completed') {
            clearInterval(pollInterval);
            pollInterval = null;
            
            // ‡πÅ‡∏õ‡∏•‡∏á result ‡∏à‡∏≤‡∏Å string ‡πÄ‡∏õ‡πá‡∏ô object
            let luckyResult;
            try {
              luckyResult = JSON.parse(result);
            } catch (e) {
              console.error('Error parsing result:', e);
              return;
            }
            
            document.getElementById('luckyNumber').value = luckyResult.luckyNumber || '';
            setMsg('msgLucky', `‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ ${luckyResult.luckyNumber}`, 'info');
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß
            updateQueueStatusCompleted(luckyResult.luckyNumber);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å
            if (!empMap[empId]) empMap[empId] = { empId: empId };
            empMap[empId].luckyNumber = luckyResult.luckyNumber;
            
          } else if (status === 'Error') {
            clearInterval(pollInterval);
            pollInterval = null;
            setMsg('msgLucky', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result}`, 'error');
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß
            document.getElementById('queueStatus').classList.add('hidden');
          }
          // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô 'Waiting' ‡∏´‡∏£‡∏∑‡∏≠ 'Processing' ‡∏Å‡πá‡∏Ñ‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ

        } catch (err) {
          clearInterval(pollInterval);
          pollInterval = null;
          console.error(err);
          setMsg('msgLucky', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
          
          // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß
          document.getElementById('queueStatus').classList.add('hidden');
        }
      }, 3000); // ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏∏‡∏Å‡πÜ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    }

    // core ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function saveCore() {
      if (isLoading) return null;
      
      var empId      = document.getElementById('empId').value.trim();
      var firstName  = document.getElementById('firstName').value.trim();
      var lastName   = document.getElementById('lastName').value.trim();
      var department = document.getElementById('department').value.trim();
      var lucky      = document.getElementById('luckyNumber').value.trim();

      if (!empId)      { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return null; }
      if (!firstName)  { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠'); return null; }
      if (!lastName)   { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'); return null; }
      if (!department) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢/‡πÅ‡∏ú‡∏ô‡∏Å'); return null; }
      if (!lucky)      { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); return null; }

      setMsg('msgSave', '', '');
      setLoading(true, ['saveBtn']);

      var existedBefore = !!empMap[empId];

      var payload = {
        empId: empId,
        firstName: firstName,
        lastName: lastName,
        department: department,
        luckyNumber: lucky
      };

      try {
        const res = await apiSaveEmployee(payload); // {success, record}
        if (!res || !res.success) {
          setMsg('msgSave', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
          return null;
        }

        var record = res.record || {};
        empMap[record.empId] = record;
        lastSavedRecord = record;

        // rebuild index ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï label ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á
        buildEmpIndex(Object.values(empMap));

        return { record: record, existedBefore: existedBefore };
      } catch (err) {
        console.error(err);
        setMsg('msgSave', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
        return null;
      } finally {
        setLoading(false, ['saveBtn']);
      }
    }

    // ‡∏õ‡∏∏‡πà‡∏°: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    async function saveOnly() {
      const result = await saveCore();
      if (!result) return;

      const existedBefore = result.existedBefore;
      setMsg(
        'msgSave',
        existedBefore
          ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
          : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
        'info'
      );
    }

    function updateTicketTabs(record) {
      var gameTab = document.getElementById('ticketGameTab');
      var iceTab  = document.getElementById('ticketIceTab');
      var gameStatus = document.getElementById('ticketGameStatus');
      var iceStatus  = document.getElementById('ticketIceStatus');

      var hasGame = !!(record && record.game);
      var hasIce  = !!(record && record.ice);

      gameTab.classList.toggle('used', hasGame);
      iceTab.classList.toggle('used', hasIce);

      gameStatus.textContent = hasGame ? '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô / ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
      iceStatus.textContent  = hasIce  ? '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô / ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
    }

    function renderTicketQr(empId) {
      var container = document.getElementById('ticketQr');
      container.innerHTML = '';
      if (!empId) return;
      new QRCode(container, {
        text: String(empId),
        width: 96,
        height: 96
      });
    }

    function renderTicketFromRecord(record) {
      if (!record) return;

      var showName = record.fullName ||
        ((record.firstName || '') + ' ' + (record.lastName || '')).trim();
      var showDept  = record.department || '-';
      var showEmp   = record.empId || '-';
      var showLucky = record.luckyNumber || '----';

      document.getElementById('ticketName').textContent  = showName || '-';
      document.getElementById('ticketDept').textContent  = showDept || '-';
      document.getElementById('ticketEmpId').textContent = showEmp || '-';
      document.getElementById('ticketLucky').textContent = showLucky || '----';

      updateTicketTabs(record);
      renderTicketQr(showEmp);

      document.getElementById('ticketSection').classList.remove('hidden');
      window.scrollTo({
        top: document.getElementById('ticketSection').offsetTop - 10,
        behavior: 'smooth'
      });
    }

    async function showTicket() {
      if (isLoading) return;
      
      if (!lastSavedRecord) {
        const confirmSave = confirm('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
        if (!confirmSave) return;
        const result = await saveCore();
        if (!result) return;
      }
      renderTicketFromRecord(lastSavedRecord);
      setMsg('msgSave', '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'info');
    }

    function printTicket() {
      const section = document.getElementById('ticketSection');
      if (section.classList.contains('hidden')) {
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" ‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }
      window.print();
    }

    // ==== Events ====
    var handleEmpIdInputDebounced = debounce(function() {
      var v = document.getElementById('empId').value;
      renderEmpSuggestions(v);

      // ‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡πÄ‡∏ï‡∏¥‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      var trimmed = v.trim();
      if (trimmed && empMap[trimmed]) {
        fillFormFromRecord(empMap[trimmed]);
        lastSavedRecord = empMap[trimmed];
      }
      // ‡πÑ‡∏°‡πà clear ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏∑‡πà‡∏ô ‡πÜ
    }, 180);

    document.getElementById('empId').addEventListener('input', handleEmpIdInputDebounced);

    document.getElementById('empId').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        triggerEmpLookup();
      } else if (e.key === 'Escape') {
        hideEmpSuggestions();
      }
    });

    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á ‚Üí ‡∏ã‡πà‡∏≠‡∏ô suggestion
    document.addEventListener('click', function(e) {
      var wrap = document.querySelector('.empid-wrap');
      if (!wrap.contains(e.target)) {
        hideEmpSuggestions();
      }
    });

    // init ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î
    initEmpIds();
  </script>
</body>
</html>
